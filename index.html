<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fighting game</title>
  </head>
  <body style="background-color: black">
    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 50px;
      "
    >
      <button
        id="startGame"
        onclick="startGame()"
        style="
          font-size: 30px;
          background-color: green;
          color: white;
          cursor: pointer;
        "
      >
        Start Game
      </button>
      <div
        id="health-info"
        style="display: flex; justify-content: space-between; width: 75%"
      >
        <p style="color: aliceblue; font-size: 20px">
          Player Health:
          <span id="player-health" style="font-size: 30px">100</span>
        </p>
        <p style="color: aliceblue; font-size: 20px">
          Enemy Health:
          <span id="enemy-health" style="font-size: 30px">100</span>
        </p>
      </div>
      <div id="game-over-screen" style="display: none">
        <div style="display: flex; flex-direction: column; align-items: center">
          <h2 style="color: aliceblue" id="winner">Game Over!</h2>
          <button
            onclick="restartGame()"
            style="font-size: 20px; cursor: pointer"
          >
            Restart
          </button>
        </div>
      </div>
    </div>

    <script>
      //Images
      let playerImage = new Image(150, 150);
      let enemyImage = new Image(150, 150);

      // Component creator
      function Component(name, value) {
        this.name = name;
        this.value = value;
      }

      // Entity creator
      function Entity() {
        Entity.prototype._count++;
        this.id = Entity.prototype._count;
        this.components = {};
        this.addComponents = function addComponent(c) {
          this.components[c.name] = c;
          return this;
        };
        this.removeComponents = function removeComponent(c) {
          delete this.components[c.name];
          return this;
        };
      }

      (function init() {
        Entity.prototype._count = 0;
      })();

      //Game settings
      let fps = 60;

      // Canvas settings
      let windowW = 500;
      let windowH = 500;

      // Entities
      const entities = [];

      //player stats
      let positionX = 300;
      let positionY = 300;
      let health = 100;
      //enemy stats
      let enemyPositionX = 900;
      let enemyPositionY = 300;
      let enemyHealth = 100;

      // Enitity initialization
      const player = new Entity()
        .addComponents(new Component("name", "player"))
        .addComponents(new Component("positionX", positionX))
        .addComponents(new Component("positionY", positionY))
        .addComponents(new Component("up", false))
        .addComponents(new Component("left", false))
        .addComponents(new Component("right", false))
        .addComponents(new Component("down", false))
        .addComponents(new Component("jump", false))
        .addComponents(new Component("kick", false))
        .addComponents(new Component("attackCooldown", 0))
        .addComponents(new Component("maxHealth", health))
        .addComponents(new Component("isAttacking", false));

      const enemy = new Entity()
        .addComponents(new Component("name", "enemy"))
        .addComponents(new Component("positionX", enemyPositionX))
        .addComponents(new Component("positionY", enemyPositionY))
        .addComponents(new Component("up", false))
        .addComponents(new Component("left", false))
        .addComponents(new Component("right", false))
        .addComponents(new Component("down", false))
        .addComponents(new Component("jump", false))
        .addComponents(new Component("attackCooldown", 0))
        .addComponents(new Component("maxHealth", enemyHealth))
        .addComponents(new Component("speed", 1.7))
        .addComponents(new Component("isAttacking", false));

      // Adding entities
      entities.push(player);
      entities.push(enemy);

      // Systems
      const systems = [];

      //End game system
      const endGameSystem = (entities) => {
        const playerHealth = entities.find(
          (e) => e.components.name.value === "player"
        ).components.maxHealth.value;
        const enemyHealth = entities.find(
          (e) => e.components.name.value === "enemy"
        ).components.maxHealth.value;

        if (playerHealth <= 0 || enemyHealth <= 0) {
          clearInterval(gameInterval);
          document.getElementById("game-over-screen").style.display = "block";
          document.getElementById("startGame").style.display = "none";
          document.getElementById("health-info").style.display = "none";
          if (playerHealth > enemyHealth) {
            document.getElementById("winner").innerText +=
              " Player win: Hey, you're pretty good!";
            document.getElementById("winner").style.color = "green";
          } else if (playerHealth == enemyHealth) {
            document.getElementById("winner").style.color = "yellow";
            document.getElementById("winner").innerText +=
              " Draw: Now this was an awesome fight!";
          } else if (playerHealth == 100) {
            document.getElementById("winner").innerText +=
              " Player win 100hp: Flawless victory!!!!";
            document.getElementById("winner").style.color = "green";
          } else if (enemyHealth == 100) {
            document.getElementById("winner").innerText +=
              " Enemy win 100hp: WOW, you are so BAD!";
            document.getElementById("winner").style.color = "red";
          } else {
            document.getElementById("winner").innerText +=
              " Enemy win: Better luck next time...";
            document.getElementById("winner").style.color = "red";
          }

          clearInterval(game);
        }

        return entities;
      };

      //Stats system
      const statsSystem = (entities) => {
        const getHealth = (type) =>
          entities
            .filter((e) => e.components.name.value === type)
            .map((e) => e.components.maxHealth.value);

        const playerHealth = getHealth("player");
        const enemyHealth = getHealth("enemy");

        document.getElementById("player-health").innerText = playerHealth;
        document.getElementById("enemy-health").innerText = enemyHealth;

        return entities;
      };

      //Combat system
      const gameCombatSystem = function (entities) {
        const calculateDistance = (entity1, entity2) => {
          return Math.sqrt(
            Math.pow(
              entity1.components.positionX.value -
                entity2.components.positionX.value,
              2
            ) +
              Math.pow(
                entity1.components.positionY.value -
                  entity2.components.positionY.value,
                2
              )
          );
        };

        const updatePlayerImage = (entity) => {
          if (
            entity.components.isAttacking !== undefined &&
            entity.components.isAttacking.value
          ) {
            playerImage.src = "PlayerAttack.png";
            entity.components.isAttacking.value = false;
          } else if (
            entity.components.kick !== undefined &&
            entity.components.kick.value
          ) {
            playerImage.src = "PlayerKick.png";
            entity.components.kick.value = false;
          } else {
            playerImage.src = "Player.png";
          }
        };

        const newEntities = entities.map((entity) => {
          if (entity.components.name.value === "player") {
            const enemyEntity = entities.find(
              (e) => e.components.name.value === "enemy"
            );

            if (enemyEntity) {
              const distance = calculateDistance(entity, enemyEntity);

              console.log(entity.components.isAttacking.value);

              if (
                distance < 50 &&
                (entity.components.isAttacking.value ||
                  entity.components.kick.value) &&
                entity.components.attackCooldown.value <= 0
              ) {
                enemyEntity.components.maxHealth.value -=
                  Math.floor(Math.random() * 5) + 1;
                entity.components.isAttacking.value = false;
                console.log(
                  "Player attacked enemy! Enemy health: " +
                    enemyEntity.components.maxHealth.value
                );

                entity.components.attackCooldown.value = fps / 2;
              }

              entity.components.attackCooldown.value = Math.max(
                0,
                entity.components.attackCooldown.value - 1
              );
            }

            updatePlayerImage(entity);
            return entity;
          } else if (entity.components.name.value === "enemy") {
            const playerEntity = entities.find(
              (e) => e.components.name.value === "player"
            );

            if (playerEntity) {
              const distance = calculateDistance(entity, playerEntity);

              if (
                distance < 50 &&
                entity.components.attackCooldown.value <= 0
              ) {
                playerEntity.components.maxHealth.value -=
                  Math.floor(Math.random() * 4) + 1;
                console.log(
                  "Enemy attacked player! Player health: " +
                    playerEntity.components.maxHealth.value
                );

                entity.components.attackCooldown.value =
                  fps / 1.5 + Math.random() * (2.5 - 1.5);
              }

              entity.components.attackCooldown.value = Math.max(
                0,
                entity.components.attackCooldown.value - 1
              );
            }
          }

          return entity;
        });

        return newEntities;
      };

      //Movment system
      const userMovmentSystem = (enteties) => {
        let newEnteties = [];
        let jumpSpeed = 10;
        let speed = 5;

        for (e of enteties) {
          let jumpHeight = 195;

          if (
            e.components.jump !== undefined &&
            e.components.positionY !== undefined
          ) {
            if (e.components.jump.value == true) {
              if (
                e.components.positionY.value >
                e.components.positionY.originalValue - jumpHeight
              ) {
                e.components.positionY.value -= jumpSpeed;
                jumpSpeed -= 0.3;
              } else {
                e.components.jump.value = false;
                jumpSpeed = 10;
                e.components.positionY.value =
                  e.components.positionY.originalValue;
              }
            }
          }

          if (
            e.components.positionY !== undefined &&
            e.components.positionY.originalValue === undefined
          ) {
            e.components.positionY.originalValue = e.components.positionY.value;
          }

          if (e.components.up?.value && e.components.positionY.value > 195) {
            e.components.positionY.value -= speed;
            e.components.up.value = false;
          }
          if (e.components.down?.value && e.components.positionY.value < 500) {
            e.components.positionY.value += speed;
            e.components.down.value = false;
          }

          if (e.components.left?.value && e.components.positionX.value > -30) {
            e.components.positionX.value -= speed;
            e.components.left.value = false;
          }

          if (
            e.components.right?.value &&
            e.components.positionX.value < 1300
          ) {
            e.components.positionX.value += speed;
            e.components.right.value = false;
          }

          newEnteties.push(e);
        }
        return newEnteties;
      };

      const userInputSystem = (function inputSystem() {
        let downEvents = [];
        let upEvents = [];
        function handleKeyDown(event) {
          downEvents.push(event.keyCode);
          downEvents = [...new Set(downEvents)];
        }
        function handleKeyUp(event) {
          upEvents.push(event.keyCode);
          upEvents = [...new Set(upEvents)];
        }
        window.addEventListener("keydown", handleKeyDown);
        window.addEventListener("keyup", handleKeyUp);
        return (entities) => {
          let newEntities = [];
          entities.map((e) => {
            //up 38
            if (downEvents.includes(38)) {
              if (e.components.positionY != undefined) {
                if (e.components.name.value === "player") {
                  e.components.up.value = true;
                  // console.log("UP button pressed!");
                }
              }
            }
            //down 40
            if (downEvents.includes(40)) {
              if (e.components.positionY != undefined) {
                if (e.components.name.value === "player") {
                  e.components.down.value = true;
                  // console.log("DOWN Button pressed!");
                }
              }
            }

            //left 37
            if (downEvents.includes(37)) {
              if (e.components.positionX != undefined) {
                if (e.components.name.value === "player") {
                  e.components.left.value = true;
                  // console.log("LEFT Button pressed!");
                }
              }
            }

            //right 39
            if (downEvents.includes(39)) {
              if (e.components.positionX != undefined) {
                if (e.components.name.value === "player") {
                  e.components.right.value = true;
                  // console.log("RIGHT Button pressed!");
                }
              }
            }
            //jump 23
            if (downEvents.includes(32) && !e.components.jump.value) {
              if (e.components.name.value === "player") {
                e.components.jump.value = true;
                // console.log("Jump button pressed!");
              }
            }

            if (
              downEvents.includes(65) &&
              e.components.isAttacking !== undefined
            ) {
              if (e.components.name.value === "player") {
                e.components.isAttacking.value = true;
                // console.log("Attack button pressed!");
              }
            }
            if (downEvents.includes(83) && e.components.kick !== undefined) {
              if (e.components.name.value === "player") {
                e.components.kick.value = true;
                // console.log("Kick button pressed!");
              }
            }

            newEntities.push(e);
          });
          downEvents = downEvents.filter((value) => !upEvents.includes(value));
          upEvents = [];
          return newEntities;
        };
      })();

      // Rendering system
      const renderingSystem = (function graphicsSystem() {
        let canvas = document.createElement("canvas");
        canvas.width = window.innerWidth / 1.3;
        canvas.height = window.innerHeight / 1.5;
        canvas.style =
          "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid black;";
        document.body.appendChild(canvas);

        let ctx = canvas.getContext("2d");
        playerImage.onload = function () {
          renderingSystem(entities);
        };

        enemyImage.onload = function () {
          renderingSystem(entities);
        };

        playerImage.src = "Player.png";
        enemyImage.src = "Enemy.png";

        let background = new Image();
        background.src = "background.png";

        const drawBackground = () => {
          ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
        };

        return (entities) => {
          ctx.clearRect(0, 0, window.innerWidth / 2, window.innerHeight / 2);
          drawBackground();
          entities.map((e) => {
            {
              if (
                e.components.positionX !== undefined &&
                e.components.positionY !== undefined
              ) {
                if (e.components.name.value === "player") {
                  ctx.drawImage(
                    playerImage,
                    e.components.positionX.value,
                    e.components.positionY.value,
                    150,
                    150
                  );
                }
                if (e.components.name.value === "enemy") {
                  ctx.drawImage(
                    enemyImage,
                    e.components.positionX.value,
                    e.components.positionY.value,
                    150,
                    150
                  );
                }
              }
            }
          });
          return entities;
        };
      })();

      const enemyAiSystem = (entities) => {
        let newEntities = [];

        entities.map((e) => {
          if (e.components.name.value === "enemy") {
            let playerEntity = entities.find(
              (entity) => entity.components.name.value === "player"
            );

            if (playerEntity) {
              if (
                e.components.positionX.value <
                playerEntity.components.positionX.value - 50
              ) {
                e.components.positionX.value += e.components.speed.value;
              } else if (
                e.components.positionX.value >
                playerEntity.components.positionX.value + 50
              ) {
                e.components.positionX.value -= e.components.speed.value;
              }

              if (
                e.components.positionY.value <
                playerEntity.components.positionY.value - 10
              ) {
                e.components.positionY.value += e.components.speed.value;
              } else if (
                e.components.positionY.value >
                playerEntity.components.positionY.value + 10
              ) {
                e.components.positionY.value -= e.components.speed.value;
              }

              let distance = Math.sqrt(
                Math.pow(
                  playerEntity.components.positionX.value -
                    e.components.positionX.value,
                  2
                ) +
                  Math.pow(
                    playerEntity.components.positionY.value -
                      e.components.positionY.value,
                    2
                  )
              );

              e.components.isAttacking.value =
                distance < 50 && !e.components.isAttacking.value ? true : false;
            }

            enemyImage.src = e.components.isAttacking.value
              ? "EnemyAttack.png"
              : "Enemy.png";
          }

          newEntities.push(e);
        });

        return newEntities;
      };

      systems.push(statsSystem);
      systems.push(endGameSystem);
      systems.push(renderingSystem);
      systems.push(userInputSystem);
      systems.push(userMovmentSystem);
      systems.push(enemyAiSystem);
      systems.push(gameCombatSystem);

      function game(entities, systems) {
        systems.map((s) => {
          entities = s(Object.freeze(entities));
        });
      }

      let gameInterval;
      let startButton = document.getElementById("startGame");

      const startGame = () => {
        startButton.disabled = true;
        gameInterval = setInterval(() => {
          game(entities, systems);
        }, 1000 / fps);
      };

      const restartGame = () => {
        clearInterval(gameInterval);
        startButton.disabled = false;

        player.components.positionX.value = positionX;
        player.components.positionY.value = positionY;
        player.components.maxHealth.value = health;

        enemy.components.positionX.value = enemyPositionX;
        enemy.components.positionY.value = enemyPositionY;
        enemy.components.maxHealth.value = enemyHealth;

        document.getElementById("game-over-screen").style.display = "none";
        document.getElementById("startGame").style.display = "block";
        document.getElementById("winner").innerText = "Game Over!";
        document.getElementById("health-info").style.display = "flex";

        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        game(entities, systems);
      };
    </script>
    <div style="font-size: 25px; color: white">Commands</div>
    <ul style="text-decoration: none">
      <li style="font-size: 15px; color: white">Use arrow keys to move</li>
      <li style="font-size: 15px; color: white">Press Space to jump</li>
      <li style="font-size: 15px; color: white">Press A to punch</li>
      <li style="font-size: 15px; color: white">Press S to kick</li>
    </ul>
  </body>
</html>
